---
import { Image } from "astro:assets";
import * as prismic from "@prismicio/client";
import { profiles } from "../../prismic.js";
import { lenderProfiles } from "../../hypgrah.js";
import Layout from "../../components/Layout.astro";
import LoanPrograms from "../../components/LoanPrograms.astro";
import Deal from "../../components/Deal.astro";
import Section from "../../components/Section.astro";
import Stat from "../../components/Stat.astro";
import StatContainer from "../../components/StatContainer.astro";
import Tabs from "../../components/Tabs.astro";
import PropertyTypes from "../../components/PropertyTypes.astro";
import numeral from "numeral";
import generateSrcSets from "../../utils/generateSrcSets.js";
import getImageUrlFromSize from "../../utils/getImageUrlFromSize.js";
import { hasArrayWithStrings } from "../../utils/array.js";
import { marked } from "marked";
import FancyList from "../../components/FancyList.astro";
import { LICENSES } from "../../constants/enums.js";

export async function getStaticPaths() {
  return lenderProfiles.map((profile) => {
    return { params: { slug: profile.slug }, props: { data: profile } };
  });
}

const { data } = Astro.props;

function formatMoneyAbbrev(n) {
  const abs = Math.abs(n);
  const pattern = abs >= 1000 ? "0,0.00a" : "0,0.00";
  return "$" + numeral(n).format(pattern);
}

function formatRange(min, max) {
  return `${formatMoneyAbbrev(min)} to ${formatMoneyAbbrev(max)}`;
}

const loanProgramTabs = data.loanPrograms.map((loanProgram) => {
  return {
    title: loanProgram.loanType,
    component: LoanPrograms,
    props: loanProgram,
  };
});

const hasLicenses =
  data.licenses?.length &&
  data.licenses.some((license) => {
    return !!license.type && !!license.value;
  });

const hasBestFeatures =
  data.bestFeatures?.length &&
  data.bestFeatures.some((item) => {
    return !!item;
  });

const hasDeals =
  !!data.lenderNews?.length &&
  !!data.lenderNews.some((deal) => {
    return !!deal && !!deal.headline;
  });

const hasAdditionalDetails = hasArrayWithStrings(data.additionalDetails);

const hasNegativeConsiderations = hasArrayWithStrings(
  data.negativeConsiderations,
);

const hasPositiveConsiderations = hasArrayWithStrings(
  data.positiveConsiderations,
);
---

<Layout metaTitle={`${data.name} - Moolah List`}>
  <div class="!w-full min-w-full border-gray-200 border-b p-3 m-0 mb-3">
    <div
      class="grid grid-cols-[50px_auto] md:grid-cols-[162px_auto] mx-auto max-w-desktop px-2 md:px-0 w-full items-start"
    >
      {
        !!data.logo &&
          !!data.logo.url ? (
            <div class="w-[50px] h-[50px] md:w-[162px] md:h-[162px] m-0 border-gray-200 border">
              <Image
                alt={`${data.name} Logo`}
                class="w-full h-full max-w-[160px]"
                densities={[1.5, 2]}
                loading="lazy"
                src={data.logo.url}
                widths={[100,200,300,400]}
                sizes="(max-width: 640px) 100px, (max-width: 768px) 150px, (max-width: 1024px) 200px, 400px"
                width={400}
                height={400}
              />
            </div>,
          ) : null
      }
      <div class="px-3 md:p-3">
        <h1 class="!text-xl">
          {data.name}
        </h1>
        <div class="text-base">
          {!!data.city && !!data.state ? `${data.city}, ${data.state}` : null}
        </div>
        {
          !!hasLicenses ? (
            <div class="text-base">
              {data.licenses.map((license, index) => {
                return `${LICENSES[license.type]} ${license.value}${index < data.licenses.length - 1 ? ", " : ""}`;
              })}
            </div>
          ) : null
        }
        <div class="text-base">
          {
            !!data.website ? (
              <a class="cursor-pointer" href={data.website} target="_blank">
                {data.website.replace(/^https?:\/\/(www\.)?|\/$/g, "")}
              </a>
            ) : null
          }
        </div>
      </div>
    </div>
  </div>
{
    data.whyWePickedThis ? (

  <Section variant="compact">
        <h2 class="text-gray-700 !mb-2">Our Take</h2>
            {data.whyWePickedThis}
  </Section>
    ) : null
  }


  {
    !!hasPositiveConsiderations || !!hasNegativeConsiderations ? (
  <Section variant="compact">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-9">
          {hasPositiveConsiderations && (
<div class="flex flex-col">
              <h2 class="block  mb-2">Funds</h2>
            <div class="grid grid-cols-1 bg-green-50 p-3">
              <div class="ml-3">
                <FancyList
                  data={data.positiveConsiderations}
                  icon="checkmark"
                />
              </div>
            </div>
            </div>
          )}
          { hasNegativeConsiderations && (
              <div class="flex flex-col h-full">

              <h2 class="block mb-2">Does Not Fund</h2>
            <div class="grid grid-cols-1 bg-red-50 p-3">
              <div class="ml-3">
                <FancyList
                  data={data.negativeConsiderations}
                  icon="crossmark"
                />
              </div>
            </div>
    </div>
          )}
    </div>
      </Section>
    ) : null
  }

  {
    !!data.loanPrograms && !!data.loanPrograms.length ? (
  <Section variant="compact">
        <h2>Loan Programs</h2>
        <Tabs tabs={loanProgramTabs} />
      </Section>
    ) : null
  }
  
  <Section variant="compact">
    <h2>{`About ${data.name}`}</h2>

    <Fragment set:html={marked.parse(data.description.markdown)} />
  </Section>

  {
    hasDeals ? (
      <Section variant="compact">
        <h2>Recent News</h2>
        {data.lenderNews.map((deal) => {
          return <Deal deal={deal} />;
        })}
      </Section>
    ) : null
  }
</Layout>
