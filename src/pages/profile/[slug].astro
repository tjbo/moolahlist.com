---
import { Image } from "astro:assets";
import * as prismic from "@prismicio/client";
import { profiles } from "../../prismic.js";
import { lenderProfiles } from "../../hypgrah.js";
import Layout from "../../components/Layout.astro";
import LoanPrograms from "../../components/LoanPrograms.astro";
import LoanSpecs from "../../components/LoanSpecs.astro";
import Deal from "../../components/Deal.astro";
import Section from "../../components/Section.astro";
import Stat from "../../components/Stat.astro";
import StatContainer from "../../components/StatContainer.astro";
import Tabs from "../../components/Tabs.astro";
import PropertyTypes from "../../components/PropertyTypes.astro";
import numeral from "numeral";
import generateSrcSets from "../../utils/generateSrcSets.js";
import getImageUrlFromSize from "../../utils/getImageUrlFromSize.js";
import { hasArrayWithStrings } from "../../utils/array.js";
import { marked } from "marked";
import FancyList from "../../components/FancyList.astro";
import { LICENSES } from "../../constants/enums.js";

export async function getStaticPaths() {
  return lenderProfiles.map((profile) => {
    return { params: { slug: profile.slug }, props: { data: profile } };
  });
}

const { data } = Astro.props;

//  this probably needs to be fixed
const image = data.logo;
const srcSets =
  !!image &&
  !!image.url &&
  generateSrcSets(
    image.url,
    [
      { w: 400, h: 400 },
      { w: 300, h: 300 },
      { w: 200, h: 200 },
      { w: 150, h: 150 },
      { w: 100, h: 100 },
    ],
    true,
  );

function formatMoneyAbbrev(n) {
  const abs = Math.abs(n);
  const pattern = abs >= 1000 ? "0,0.00a" : "0,0.00";
  return "$" + numeral(n).format(pattern);
}

function formatRange(min, max) {
  return `${formatMoneyAbbrev(min)} to ${formatMoneyAbbrev(max)}`;
}

const loanProgramTabs = data.loanPrograms.map((loanProgram) => {
  return {
    title: loanProgram.loanType,
    component: LoanPrograms,
    props: loanProgram,
  };
});

const hasLicenses =
  data.licenses?.length &&
  data.licenses.some((license) => {
    return !!license.type && !!license.value;
  });

const hasBestFeatures =
  data.bestFeatures?.length &&
  data.bestFeatures.some((item) => {
    return !!item;
  });

const hasDeals =
  !!data.lenderNews?.length &&
  !!data.lenderNews.some((deal) => {
    return !!deal && !!deal.headline;
  });

const hasAdditionalDetails = hasArrayWithStrings(data.additionalDetails);

const hasNegativeConsiderations = hasArrayWithStrings(
  data.negativeConsiderations,
);

const hasPositiveConsiderations = hasArrayWithStrings(
  data.positiveConsiderations,
);
---

<Layout metaTitle={`${data.name} - Moolah List`}>
  <div class="!w-full min-w-full border-gray-200 border-b p-3 m-0">
    <div
      class="grid grid-cols-[50px_auto] md:grid-cols-[162px_auto] mx-auto max-w-[1024px] px-6 w-full items-start"
    >
      {
        !!image && !!image.url && (
          <div class="w-[50px] h-[50px] md:w-[162px] md:h-[162px] m-0 border-gray-200 border">
            <Image
              alt={!!image.alt ? image.alt : ""}
              class="w-full h-full max-w-[160px]"
              loading="lazy"
              sizes="(max-width: 640px) 95vw, (min-width: 768px) 44vw, (min-width: 1252px) 552px"
              src={getImageUrlFromSize(image.url, 576, 432, true)}
              srcSet={srcSets}
              width="300"
              height="300"
            />
          </div>
        )
      }
      <div class="px-3 md:p-3">
        <h1 class="!text-xl md:!text-3xl">
          {data.name}
        </h1>
        <div class="text-base">
          {!!data.city && !!data.state ? `${data.city}, ${data.state}` : null}
        </div>
        {
          !!hasLicenses ? (
            <div class="text-base">
              {data.licenses.map((license, index) => {
                return `${LICENSES[license.type]} ${license.value}${index < data.licenses.length - 1 ? ", " : ""}`;
              })}
            </div>
          ) : null
        }
        <div class="text-base">
          {
            !!data.website ? (
              <a class="cursor-pointer" href={data.website} target="_blank">
                {data.website.replace(/^https?:\/\/(www\.)?|\/$/g, "")}
              </a>
            ) : null
          }
        </div>
      </div>
    </div>
  </div>
  <Section>
    <h2 set:html={marked.parse(data.headline)} />
    <Fragment set:html={marked.parse(data.description.markdown)} />
  </Section>
  {
    hasBestFeatures ? (
      <Section>
        <div class=" py-9 border-solid best-features-box">
          <h2 class="text-gray-700">Why Borrowers Choose This Lender</h2>
          <ul class="!ml-0">
            {data.bestFeatures.map((f) => {
              return (
                <li class="text-xl md:text-2xl !ml-0 md:!ml-4 mb-1">{f}</li>
              );
            })}
          </ul>
        </div>
      </Section>
    ) : null
  }

  {
    !!data.loanPrograms && !!data.loanPrograms.length ? (
      <Section>
        <h2>Loan Programs</h2>
        <Tabs tabs={loanProgramTabs} />
      </Section>
    ) : null
  }

  {
    !!hasPositiveConsiderations || !!hasNegativeConsiderations ? (
      <Section>
        <div class="hidden md:grid grid-cols-1 md:grid-cols-2 gap-9">
          <h2>What We Fund</h2>
          <h2>What We Don't Fund</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-9">
          {hasPositiveConsiderations && (
            <>
              <h2 class="block !mb-0 md:hidden">What We Fund</h2>
              <div class="card">
                <FancyList
                  data={data.positiveConsiderations}
                  icon="checkmark"
                />
              </div>
            </>
          )}
          {hasNegativeConsiderations && (
            <>
              <h2 class="block !mb-0 md:hidden">What We Don't Fund</h2>
              <div class="card">
                <FancyList
                  data={data.negativeConsiderations}
                  icon="crossmark"
                />
              </div>
            </>
          )}
        </div>
      </Section>
    ) : null
  }
  {
    hasDeals ? (
      <Section>
        <h2>Recent News</h2>
        {data.lenderNews.map((deal) => {
          return <Deal deal={deal} />;
        })}
      </Section>
    ) : null
  }
</Layout>
